{% extends 'tours/base.html' %}
{% block title %}{{ tour.title }} - Safarnama{% endblock %}

{% block content %}

<style>
/* ================== Styles ================== */
.tour-detail { width:90%; max-width:1200px; margin:30px auto; background:white; border-radius:14px; box-shadow:0 3px 10px rgba(0,0,0,0.12); overflow:hidden; }
#tourCarousel img { width:100%; height:450px; object-fit:cover; }
.tour-info { padding:35px 40px; }
.tour-info h2 { color:#0d6efd; font-weight:700; font-size:30px; }
.tour-meta { color:#555; margin-top:5px; font-size:15px; }
.price-box { background:#eef5ff; padding:12px; border-radius:8px; margin-top:15px; font-weight:600; color:#0d6efd; font-size:20px; }
.tour-desc { margin-top:20px; color:#444; line-height:1.7; font-size:17px; }
.avg-rating { display:flex; align-items:center; margin-top:20px; }
.avg-rating .num { font-size:26px; font-weight:700; color:#0d6efd; margin-right:8px; }
.rating { color:#ffc107; font-size:20px; }
.reviews-container { margin:60px auto; width:90%; max-width:1100px; }
.reviews-container h2 { color:#0d6efd; font-weight:700; text-align:center; margin-bottom:5px; }
.reviews-container p.subtitle { color:#555; text-align:center; margin-bottom:30px; }
.reviews-grid { display:grid; grid-template-columns:repeat(auto-fit, minmax(280px,1fr)); gap:25px; }
.review-card { background:#fff; padding:20px; border-radius:12px; box-shadow:0 4px 15px rgba(0,0,0,0.08); transition:transform 0.3s, box-shadow 0.3s; }
.review-card:hover { transform:translateY(-5px); box-shadow:0 10px 25px rgba(0,0,0,0.12); }
.review-card .review-header { display:flex; justify-content:space-between; align-items:center; margin-bottom:8px; }
.review-card .review-header .user-name { font-weight:600; color:#0d6efd; }
.review-card .review-header .date { font-size:13px; color:#777; }
.review-card .stars { font-size:18px; margin-bottom:10px; }
.review-card:nth-child(odd) { background:#f9faff; }
#reviewModal { display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:9999; }
#reviewModal .modal-content { background:white; padding:30px; border-radius:12px; width:420px; position:relative; animation:fadeIn 0.3s ease; }
@keyframes fadeIn { from { opacity:0; transform:scale(0.9); } to { opacity:1; transform:scale(1); } }
#reviewModal label { font-weight:500; margin-top:10px; display:block; }
#reviewModal textarea { width:100%; border-radius:8px; padding:10px; margin-top:5px; border:1px solid #ccc; }
#reviewModal button { border:none; border-radius:8px; padding:10px; font-size:16px; }
#reviewModal .btn-success { background:#0d6efd; color:white; }
#reviewModal .btn-secondary { background:#6c757d; color:white; margin-top:10px; }
.book-btn { background:#0d6efd; color:white; padding:12px 25px; border:none; border-radius:8px; cursor:pointer; font-size:16px; }
.booked-btn { background:#6c757d; color:white; padding:12px 25px; border:none; border-radius:8px; cursor:not-allowed; font-size:16px; }
@media(max-width:768px){ .tour-info { padding:25px 20px; } }
</style>

<!-- ================== TOUR DETAIL ================== -->
<div class="tour-detail">

    <!-- Carousel -->
    <div id="tourCarousel" class="carousel slide" data-bs-ride="carousel">
        <div class="carousel-indicators">
            {% if images %}
                {% for img in images %}
                    <button type="button" data-bs-target="#tourCarousel" data-bs-slide-to="{{ forloop.counter0 }}"
                    {% if forloop.first %}class="active"{% endif %}></button>
                {% endfor %}
            {% else %}
                <button type="button" data-bs-target="#tourCarousel" data-bs-slide-to="0" class="active"></button>
            {% endif %}
        </div>
        <div class="carousel-inner">
            {% if images %}
                {% for img in images %}
                    <div class="carousel-item {% if forloop.first %}active{% endif %}">
                        <img src="{{ img.display_image }}" class="d-block w-100">
                    </div>
                {% endfor %}
            {% else %}
                <div class="carousel-item active">
                    <img src="{{ tour.display_image }}" class="d-block w-100">
                </div>
            {% endif %}
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#tourCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon"></span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#tourCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon"></span>
        </button>
    </div>

    <!-- Tour Info -->
    <div class="tour-info">
        <h2>{{ tour.title }}</h2>
        <p class="tour-meta">üìç {{ tour.location }} | ‚è± {{ tour.duration }}</p>
        <div class="price-box">üí∞ ‚Çπ{{ tour.price }}</div>

        <div style="margin-top:25px;">
            {% if user.is_authenticated %}
                {% if already_booked %}
                    <button class="booked-btn">‚úÖ Already Booked</button>
                {% else %}
                    <a href="{% url 'payment:book_now' tour.id %}">
                        <button class="book-btn">üõí Book Now</button>
                    </a>
                {% endif %}
            {% else %}
                <p><a href="{% url 'login' %}?next={{ request.path }}" style="color:#0d6efd;">Login</a> to book this tour.</p>
            {% endif %}
        </div>

        <p class="tour-desc">{{ tour.description }}</p>

        {% if tour.average_rating %}
        <div class="avg-rating">
            <span class="num">{{ tour.average_rating|floatformat:1 }}</span>
            <span class="rating">
                {% for i in "12345"|make_list %}
                  {% if forloop.counter <= tour.average_rating %}‚òÖ{% else %}‚òÜ{% endif %}
                {% endfor %}
            </span>
        </div>
        {% endif %}
    </div>
</div>

<!-- ================== REVIEWS SECTION ================== -->
<div class="reviews-container">
    <h2>Traveler Reviews</h2>
    <p class="subtitle">See what travelers experienced on <strong>{{ tour.title }}</strong></p>

    <div class="reviews-grid" id="reviewsGrid">
        {% include 'tours/review_cards.html' %}
    </div>

    {% if reviews.has_next %}
    <div style="text-align:center; margin-top:20px;">
        <button id="loadMoreBtn" class="book-btn" data-next-page="2">Load More Reviews</button>
    </div>
    {% endif %}
</div>

<!-- ================== WRITE REVIEW BUTTON ================== -->
<div style="text-align:center; margin:40px 0;">
    {% if user.is_authenticated %}
    <button id="openReviewModal" class="book-btn">‚úçÔ∏è Write a Review</button>
    {% else %}
    <p><a href="{% url 'login' %}?next={{ request.path }}" style="color:#0d6efd;">Login</a> to write a review.</p>
    {% endif %}
</div>

<!-- ================== REVIEW MODAL ================== -->
<div id="reviewModal">
    <div class="modal-content">
        <h4>Add Review</h4>
        <form method="POST" action="{% url 'tours:add_review' tour.id %}">
        {% csrf_token %}
        <label>Rating</label>
        <div id="starRating" style="font-size:26px; cursor:pointer;">
            <span data-value="1">‚òÖ</span>
            <span data-value="2">‚òÖ</span>
            <span data-value="3">‚òÖ</span>
            <span data-value="4">‚òÖ</span>
            <span data-value="5">‚òÖ</span>
        </div>
        <input type="hidden" name="rating" id="ratingInput" value="0">

        <label>Comment</label>
        <textarea name="comment" rows="3"></textarea>

        <button class="btn btn-success mt-3 w-100">Submit Review</button>
        </form>

        <button id="closeModal" class="btn btn-secondary mt-2 w-100">Close</button>
    </div>
</div>

<!-- ================== JS ================== -->
<script>
// Modal
const modal = document.getElementById('reviewModal');
const openBtn = document.getElementById('openReviewModal');
const closeBtn = document.getElementById('closeModal');
if(openBtn) openBtn.onclick = () => modal.style.display = 'flex';
if(closeBtn) closeBtn.onclick = () => modal.style.display = 'none';
window.onclick = e => { if(e.target === modal) modal.style.display = 'none'; };

// ‚≠ê Rating System
const stars = document.querySelectorAll('#starRating span');
const ratingInput = document.getElementById("ratingInput");
stars.forEach(star => {
    star.addEventListener("mouseover", () => highlight(star.dataset.value));
    star.addEventListener("click", () => { ratingInput.value = star.dataset.value; highlight(star.dataset.value); });
});
document.getElementById("starRating").addEventListener("mouseleave", () => highlight(ratingInput.value));
function highlight(count){
    stars.forEach(s => { s.style.color = s.dataset.value <= count ? "#ffc107" : "#ccc"; });
}

// AJAX Load More Reviews
const loadMoreBtn = document.getElementById('loadMoreBtn');
const reviewsGrid = document.getElementById('reviewsGrid');

if(loadMoreBtn){
    loadMoreBtn.addEventListener('click', () => {
        let page = loadMoreBtn.dataset.nextPage;
        const url = "{% url 'tours:load_more_reviews' tour.id %}?page=" + page;

        fetch(url)
        .then(res => res.json())
        .then(data => {
            reviewsGrid.insertAdjacentHTML('beforeend', data.html);
            if(data.has_next){ loadMoreBtn.dataset.nextPage = parseInt(page) + 1; }
            else{ loadMoreBtn.style.display = 'none'; }
        }).catch(err => console.error(err));
    });
}
</script>

{% endblock %}
