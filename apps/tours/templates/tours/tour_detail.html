{% extends 'tours/base.html' %}
{% block title %}{{ tour.title }} - Safarnama{% endblock %}

{% block content %}
<style>
  .tour-detail {
    width: 85%;
    margin: 30px auto;
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.1);
    overflow: hidden;
    transition: all 0.3s ease;
  }

  .tour-banner img {
    width: 100%;
    height: 400px;
    object-fit: cover;
  }

  .tour-info {
    padding: 30px;
  }

  .tour-info h2 {
    color: #0d6efd;
    margin-bottom: 10px;
    font-weight: 700;
  }

  .tour-meta {
    color: #555;
    margin-bottom: 15px;
    font-size: 15px;
  }

  .tour-desc {
    color: #444;
    line-height: 1.7;
    font-size: 16px;
    margin-top: 10px;
  }

  .price-box {
    background: #eef5ff;
    padding: 15px;
    border-radius: 8px;
    margin-top: 15px;
    font-weight: 600;
    color: #0d6efd;
    font-size: 18px;
  }

  /* Reviews */
  .reviews {
    margin-top: 40px;
  }

  .reviews h3 {
    color: #0d6efd;
    font-weight: 600;
    margin-bottom: 15px;
  }

  .review-card {
    background: #f9f9f9;
    padding: 18px;
    border-radius: 10px;
    margin-bottom: 12px;
    transition: 0.3s ease;
  }

  .review-card:hover {
    background: #f1f7ff;
  }

  .rating {
    color: #ffc107;
    font-size: 18px;
  }

  .avg-rating {
    display: flex;
    align-items: center;
    margin-bottom: 15px;
  }

  .avg-rating .num {
    font-size: 24px;
    font-weight: 700;
    color: #0d6efd;
    margin-right: 8px;
  }

  .no-reviews {
    background: #f9f9f9;
    padding: 20px;
    border-radius: 8px;
    color: #666;
  }
</style>

<div class="tour-detail">
  <!-- Tour Banner -->
  <div class="tour-banner">
    <img src="{{ tour.display_image }}" alt="{{ tour.title }}">
  </div>

  <!-- Tour Info -->
  <div class="tour-info">
    <h2>{{ tour.title }}</h2>
    <p class="tour-meta">üìç {{ tour.location }} | ‚è± {{ tour.duration }}</p>
    <div class="price-box">üí∞ ‚Çπ{{ tour.price }}</div>

    <p class="tour-desc">{{ tour.description }}</p>

    <!-- Average Rating -->
    {% if tour.average_rating %}
      <div class="avg-rating">
        <span class="num">{{ tour.average_rating|floatformat:1 }}</span>
        <span class="rating">
          {% for i in "12345"|make_list %}
            {% if forloop.counter <= tour.average_rating %}
              ‚òÖ
            {% else %}
              ‚òÜ
            {% endif %}
          {% endfor %}
        </span>
      </div>
    {% endif %}

   <!-- üåü USER REVIEWS SECTION -->
<div class="reviews-container" style="margin:60px auto; max-width:900px; text-align:center;">
  <h2 style="color:#0d6efd; font-weight:700; margin-bottom:10px;">Traveler Reviews & Experiences</h2>
  <p style="color:#555; font-size:15px; margin-bottom:30px;">
    Hear what our guests say about their unforgettable moments with <strong>{{ tour.title }}</strong> ‚ú®
  </p>

  {% if reviews %}
    <div class="reviews-grid" style="display:grid; grid-template-columns:repeat(auto-fit, minmax(280px,1fr)); gap:25px;">
      {% for r in reviews %}
        <div class="review-card" style="background:white; border-radius:15px; padding:20px; box-shadow:0 6px 18px rgba(0,0,0,0.08); text-align:left; transition:all 0.3s ease;">
          <div style="display:flex; align-items:center; margin-bottom:10px;">
            <!-- üßë Avatar Circle -->
            <div style="width:45px; height:45px; border-radius:50%; background:#0d6efd; color:white; display:flex; align-items:center; justify-content:center; font-weight:600; font-size:18px; margin-right:12px;">
              {{ r.user.first_name|first|upper }}
            </div>
            <div>
              <strong style="font-size:16px;">{{ r.user.first_name|default:"Guest" }}</strong><br>
              <small style="color:#888;">{{ r.created_at|date:"M d, Y" }}</small>
            </div>
          </div>

          <!-- ‚≠ê Rating -->
          <div class="rating" style="color:#ffc107; margin-bottom:8px; font-size:18px;">
            {% for i in "12345"|make_list %}
              {% if forloop.counter <= r.rating %}
                ‚òÖ
              {% else %}
                ‚òÜ
              {% endif %}
            {% endfor %}
          </div>

          <!-- üí¨ Comment -->
          <p style="font-size:15px; color:#333; line-height:1.5;">
            "{{ r.comment }}"
          </p>
        </div>
      {% endfor %}
    </div>
  {% else %}
    <div class="no-reviews" style="background:#f8f9fa; border-radius:12px; padding:40px; box-shadow:inset 0 0 12px rgba(0,0,0,0.05);">
      <h4 style="color:#555;">No reviews yet üòî</h4>
      <p style="color:#777;">Be the first to share your amazing experience with us ‚Äî your story inspires future travelers!</p>
    </div>
  {% endif %}
</div>


<style>
  .review-card:hover {
    transform: translateY(-5px);
    box-shadow:0 10px 20px rgba(0,0,0,0.1);
  }
</style>

<!-- ‚ú≥Ô∏è Write Review Section -->
<div style="text-align:center; margin:40px 0;">
  {% if user.is_authenticated %}
    <button id="openReviewModal" style="background:#0d6efd;color:white;padding:10px 20px;border:none;border-radius:5px;cursor:pointer;">
      ‚úçÔ∏è Write a Review
    </button>
  {% else %}
    <p><a href="{% url 'login' %}?next={{ request.path }}" style="color:#0d6efd;">Login</a> to write a review.</p>
  {% endif %}
</div>

<!-- üí¨ Modal Popup -->
<div id="reviewModal" class="modal" style="display:none; position:fixed; top:0; left:0; width:100%; height:100%; background:rgba(0,0,0,0.5); justify-content:center; align-items:center; z-index:9999;">
  <div style="background:white; padding:30px; border-radius:12px; width:400px; position:relative; box-shadow:0 4px 12px rgba(0,0,0,0.2); animation:fadeIn 0.3s ease;">
    <span id="closeModal" style="position:absolute; top:10px; right:15px; font-size:20px; cursor:pointer;">‚úñ</span>
    <h3 style="color:#0d6efd; text-align:center;">Share Your Experience</h3>
    <form method="post" action="{% url 'tours:add_review' tour.id %}" style="margin-top:20px;">
      {% csrf_token %}
      <div style="text-align:center; margin-bottom:15px;">
        <label style="font-weight:600;">Your Rating:</label><br>
        <div id="starRating" style="font-size:26px; color:#ccc; cursor:pointer;">
          ‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ
        </div>
        <input type="hidden" name="rating" id="ratingInput" value="0">
      </div>

      <textarea name="comment" rows="4" placeholder="Write your review..." required style="width:100%; padding:10px; border-radius:8px; border:1px solid #ccc;"></textarea>
      
      <button type="submit" style="margin-top:15px; background:#0d6efd; color:white; border:none; padding:10px 20px; border-radius:8px; cursor:pointer; width:100%;">
        Submit Review
      </button>
    </form>
  </div>
</div>

<style>
  @keyframes fadeIn { from { opacity:0; transform:scale(0.95); } to { opacity:1; transform:scale(1); } }
</style>

<script>
  const modal = document.getElementById('reviewModal');
  const openBtn = document.getElementById('openReviewModal');
  const closeBtn = document.getElementById('closeModal');
  const stars = document.getElementById('starRating');
  const ratingInput = document.getElementById('ratingInput');

  if (openBtn) openBtn.addEventListener('click', () => modal.style.display = 'flex');
  if (closeBtn) closeBtn.addEventListener('click', () => modal.style.display = 'none');
  window.addEventListener('click', e => { if (e.target === modal) modal.style.display = 'none'; });

  // ‚≠ê Interactive Star Selection
  stars.addEventListener('mousemove', updateStars);
  stars.addEventListener('click', updateStars);

  function updateStars(e) {
    const rect = stars.getBoundingClientRect();
    const x = e.clientX - rect.left;
    const starWidth = rect.width / 5;

    // ‚úÖ Use Math.min to ensure maximum 5 stars
    let selectedStars = Math.min(Math.ceil(x / starWidth), 5);

    // Update display
    stars.innerHTML = '‚òÖ‚òÖ‚òÖ‚òÖ‚òÖ'
      .split('')
      .map((s, i) => (i < selectedStars ? '‚òÖ' : '‚òÜ'))
      .join('');

    stars.style.color = '#ffc107';
    ratingInput.value = selectedStars;
  }
</script>


{% endblock %}
