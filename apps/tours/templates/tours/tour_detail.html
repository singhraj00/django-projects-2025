{% extends 'tours/base.html' %}
{% block title %}{{ tour.title }} - Safarnama{% endblock %}

{% block content %}

{% load static %}
<link rel="stylesheet" href="{% static 'tours/css/tour_detail.css' %}">
<script src="{% static 'tours/js/review.js' %}"></script>

<!-- ================== TOUR DETAIL ================== -->
<div class="tour-detail">

    <!-- Carousel -->
    <div id="tourCarousel" class="carousel slide" data-bs-ride="carousel">
        <div class="carousel-indicators">
            {% if images %}
                {% for img in images %}
                    <button type="button" data-bs-target="#tourCarousel" data-bs-slide-to="{{ forloop.counter0 }}"
                    {% if forloop.first %}class="active"{% endif %}></button>
                {% endfor %}
            {% else %}
                <button type="button" data-bs-target="#tourCarousel" data-bs-slide-to="0" class="active"></button>
            {% endif %}
        </div>
        <div class="carousel-inner">
            {% if images %}
                {% for img in images %}
                    <div class="carousel-item {% if forloop.first %}active{% endif %}">
                        <img src="{{ img.display_image }}" class="d-block w-100">
                    </div>
                {% endfor %}
            {% else %}
                <div class="carousel-item active">
                    <img src="{{ tour.display_image }}" class="d-block w-100">
                </div>
            {% endif %}
        </div>
        <button class="carousel-control-prev" type="button" data-bs-target="#tourCarousel" data-bs-slide="prev">
            <span class="carousel-control-prev-icon"></span>
        </button>
        <button class="carousel-control-next" type="button" data-bs-target="#tourCarousel" data-bs-slide="next">
            <span class="carousel-control-next-icon"></span>
        </button>
    </div>

    <!-- Tour Info -->
    <div class="tour-info">
        <h2>{{ tour.title }}</h2>
        <p class="tour-meta">üìç {{ tour.location }} | ‚è± {{ tour.duration }}</p>
        <div class="price-box">üí∞ ‚Çπ{{ tour.price }}</div>

        <div style="margin-top:25px;">
            {% if user.is_authenticated %}
                {% if already_booked %}
                    <button class="booked-btn">‚úÖ Already Booked</button>
                {% else %}
                    <a href="{% url 'payment:book_now' tour.id %}">
                        <button class="book-btn">üõí Book Now</button>
                    </a>
                {% endif %}
            {% else %}
                <p><a href="{% url 'login' %}?next={{ request.path }}" style="color:#0d6efd;">Login</a> to book this tour.</p>
            {% endif %}
        </div>

        <p class="tour-desc">{{ tour.description }}</p>

        {% if tour.average_rating %}
        <div class="avg-rating">
            <span class="num">{{ tour.average_rating|floatformat:1 }}</span>
            <span class="rating">
                {% for i in "12345"|make_list %}
                  {% if forloop.counter <= tour.average_rating %}‚òÖ{% else %}‚òÜ{% endif %}
                {% endfor %}
            </span>
        </div>
        {% endif %}
    </div>
</div>

<!-- ================== REVIEWS SECTION ================== -->
<div class="reviews-container">
    <h2>Traveler Reviews</h2>
    <p class="subtitle">See what travelers experienced on <strong>{{ tour.title }}</strong></p>

    <div class="reviews-grid" id="reviewsGrid">
        {% include 'tours/review_cards.html' %}
    </div>

    {% if reviews.has_next %}
    <div style="text-align:center; margin-top:20px;">
        <button id="loadMoreBtn" class="book-btn" data-next-page="2">Load More Reviews</button>
    </div>
    {% endif %}
</div>

<!-- ================== WRITE REVIEW BUTTON ================== -->
<div style="text-align:center; margin:40px 0;">
    {% if user.is_authenticated %}
    <button id="openReviewModal" class="book-btn">‚úçÔ∏è Write a Review</button>
    {% else %}
    <p><a href="{% url 'login' %}?next={{ request.path }}" style="color:#0d6efd;">Login</a> to write a review.</p>
    {% endif %}
</div>

<!-- ================== REVIEW MODAL ================== -->
<div id="reviewModal">
    <div class="modal-content">
        <h4>Add Review</h4>
        <form method="POST" action="{% url 'tours:add_review' tour.id %}">
        {% csrf_token %}
        <label>Rating</label>
        <div id="starRating" style="font-size:26px; cursor:pointer;">
            <span data-value="1">‚òÖ</span>
            <span data-value="2">‚òÖ</span>
            <span data-value="3">‚òÖ</span>
            <span data-value="4">‚òÖ</span>
            <span data-value="5">‚òÖ</span>
        </div>
        <input type="hidden" name="rating" id="ratingInput" value="0">

        <label>Comment</label>
        <textarea name="comment" rows="3"></textarea>

        <button class="btn btn-success mt-3 w-100">Submit Review</button>
        </form>

        <button id="closeModal" class="btn btn-secondary mt-2 w-100">Close</button>
    </div>
</div>

{% endblock %}
